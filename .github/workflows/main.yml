name: Build & Deploy to Staging

on:
  push:
    branches:
      - dev

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          script: |
            echo "Navigating to repo folder..."
            cd /var/www/html/1stop/1stopfrontend || exit 1

            echo "Pulling latest code from dev branch..."
            git reset --hard
            git clean -fd
            git pull origin dev

            echo "Creating .env file..."
            # Create a basic .env file with production settings
            cat > .env << 'EOF'
            # Auto-generated .env file for production
            NEXT_PUBLIC_API_URL=http://your-api-url:3000/api
            NODE_ENV=production
            EOF

            echo "Installing dependencies..."
            npm ci --production=false

            echo "Building Next.js project..."
            npm run build

            echo "Restarting application..."
            # Kill any existing process on port 3001
            sudo fuser -k 3001/tcp || true

            # Start the application in background
            nohup npm start > /var/log/1stopfrontend.log 2>&1 &

            # Wait a moment and check if the process started
            sleep 5
            if pgrep -f "node.*next.*start" > /dev/null; then
              echo "Application started successfully!"
            else
              echo "Warning: Application may not have started properly. Check logs at /var/log/1stopfrontend.log"
            fi

            echo "Deployment finished!"
